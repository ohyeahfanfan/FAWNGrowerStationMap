<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <title></title>
    <script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
    <script src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script src="js/Station.js" type="text/javascript"></script>
    <script src="js/MadisStation.js" type="text/javascript"></script>
    <script src="js/FawnStation.js" type="text/javascript"></script>
    <script src="js/GrowerStation.js" type="text/javascript"></script>
    <script src="js/GladStoneFamilyStation.js" type="text/javascript"></script>
    <script src="js/markerwithlabel.js"></script>
    <script src="js/map.js"></script>
    <!--function needed to display the map-->
    <link rel="stylesheet" href="css/mapStyle.css">
    <!-- Full Screen Google Map -->
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #map {
            height: 100%
        }
    </style>
</head>
<body>
<!-- RECOMMENDED if your web app will not function without JavaScript enabled -->
<noscript>
    <div style="width: 22em; position: absolute; left: 50%; margin-left: -11em; color: red; background-color: white; border: 1px solid red; padding: 4px; font-family: sans-serif">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
    </div>
</noscript>
<!--[if lt IE 9]>

<div class="ui-widget">
    <div class="ui-state-highlight ui-corner-all">
        <strong>Hey!</strong>
        Looks like your browser is out of date. Why not update to the latest version? Click <a
            href="http://windows.microsoft.com/en-US/windows-8/internet-explorer">Update</a>
    </div>
<![endif]-->
<div id="map">
</div>
<script>
var map = initMap();

var screenWidth = (window.screen.availWidth > 1680 ? 1680
        : window.screen.availWidth); // is it time consuming?
// alert(screenWidth);
var screenHeight = (window.screen.availHeight > 1050 ? 1050
        : window.screen.availHeight);
var preInfoBox = null; // globel;
var markers = []; // globel
var previousData = [];// globel
var fawnStnData = [];
var madisStnData = [];
var growerStnData = [];

function fetch(url, type) {
    var Stns
    if ($.browser.msie && window.XDomainRequest) {
        // Use Microsoft XDR
        var xdr = new XDomainRequest();
        xdr.open("get", url);
        xdr.onload = function () {
            var JSON = $.parseJSON(xdr.responseText);
            if (JSON == null || typeof (JSON) == 'undefined') {
                JSON = $.parseJSON(data.firstChild.textContent);
            }
            Stns = JSON;
            if (type == 1) {
                var StnObjs = createStnObjs(Stns.stnsWxData, type);
                fawnStnData = StnObjs;
            }
            else if (type == 2) {
                var StnObjs = createStnObjs(Stns, type);
                madisStnData = StnObjs;
            }
            else if (type == 3) {
                var StnObjs = createStnObjs(Stns, type);
                growerStnData = StnObjs;
            }

        };
        xdr.send();

    } else {
        $.getJSON(
                url,
                function (data) {
                    Stns = data;
                    if (type == 1) {
                        var StnObjs = createStnObjs(Stns.stnsWxData, type);
                        fawnStnData = StnObjs;
                    }
                    else if (type == 2) {
                        var StnObjs = createStnObjs(Stns, type);
                        madisStnData = StnObjs;
                    }
                    else if (type == 3) {
                        var StnObjs = createStnObjs(Stns, type);
                        growerStnData = StnObjs;
                    }
                    //alert("aaaa"+ fawnStnData.length);
                });
    }
}
function loadData() {
    var fawnurl = 'http://test.fawn.ifas.ufl.edu/controller.php/latestmapjson/';
    var madisurl = 'http://test.fawn.ifas.ufl.edu/controller.php/nearbyNonFawn/all/';
    var growerurl = 'http://fdacswx.fawn.ifas.ufl.edu/index.php/dataservice/observation/latest/format/json/';
    fetch(fawnurl, 1);
    fetch(madisurl, 2);
    fetch(growerurl, 3);
}
function showData(stnData) {
    //alert("showFwan");
    previousData = previousData.concat(stnData);
    //alert(previousData.length);
    fillDataSeperately(previousData);
    boundAjusted();
}

function boundAjusted() {
    google.maps.event.addListener(map, 'bounds_changed', function () {
        fillDataSeperately(previousData);
    });
}
function fillDataSeperately(newObjs) {
    var preBound = null;
    var bound = getBounds(map);
    if (preBound != null) {
        if (bound.ignore(preBound)) {
            return;
        }
    }
    var inBoundNewObjs = filter(newObjs, bound);
    // alert("inBoundNewObjs:"+inBoundNewObjs.length);
    var noOverlapNewObjs = removeOverlap([], inBoundNewObjs, bound
            .pixelsPerRadLat(), bound.pixelsPerRadLng());
    // alert("noOverlapNewObjs:"+noOverlapNewObjs.length);
    clearOverlays(markers);
    markers = loadStnMarkers(noOverlapNewObjs);
    preBound = bound;
}
function clearOverlays(markers) {
    if (Object.prototype.toString.call(markers) === '[object Array]') {
        for (var i = 0; i < markers.length; i++) {
            markers[i].setMap(null);
        }
    }
}
function loadStnMarkers(stnObjs) {
    var image = 'image/marker.png';
    var markers = [];
    for (var i = 0; i < stnObjs.length; i++) {
        markers[i] = new MarkerWithLabel({
            position: new google.maps.LatLng(stnObjs[i].lat, stnObjs[i].lng),
            draggable: false,
            raiseOnDrag: false,
            map: map,
            labelContent: stnObjs[i].getLabelContent(),
            labelAnchor: new google.maps.Point(22, 0),
            labelClass: "labels", // the CSS class for the label
            // labelStyle: {opacity: 0.85},
            icon: image
        });
        bindInfoBox1(markers[i], stnObjs[i]);
    }
    return markers;
}
function bindInfoBox1(marker, stnObj) {
    google.maps.event.addListener(marker, "click", function (e) {
        var ib = createInfoBox(stnObj)
        ib.open(map, this);
        // close previous information box
        if (preInfoBox != null) {
            preInfoBox.close();
        }
        preInfoBox = ib;
    });
}

function bindInfoBox(marker, stnObj) {
    google.maps.event.addListener(marker, "click", function (e) {
        var id = document.getElementById("map");
        var id2 = document.getElementById("list");
        id.style.display = 'none';
        // <a href="tower_data.html?id="KPNS"">81</a>
        // var id=stnObj.stnID;
        // window.location.href='tower_data.html?id=304';
        var ib = showInfoBox(stnObj)
        id2.style.display = '';
        // ib.open(map, this);

        // if(preInfoBox != null){
        // preInfoBox.close();
        // }
        // preInfoBox = ib;
    });
}
function showInfoBox(stnObj) {
    var listText = document.getElementById("list");
    listText.innerHTML = '<div class="boxWrap">' + '<h3>'
            + stnObj.getStationTitle()
            + '</h3>'
            + '<ol class="tags">'
            + '<li><a href="#"><span class="meta">'
            + stnObj.stnID
            + '</span> Tower ID</a></li>'
            + '<li><a href="#"><span class="meta">'
            + stnObj.getDateTime()
            + '</span> Time</a></li>'
            + '<li><a href="#"><span class="meta">'
            + stnObj.getTemp()
            + '&degF</span> Air Temp</a></li>'
            + '<li><a href="#"><span class="meta">8</span> Wet Bulb</a></li>'
            + '<li><a href="#"><span class="meta">56</span> Humidity</a></li>'
            + '<li><a href="#"><span class="meta">56</span> Wind Direction</a></li>'
            + '<li><a href="#"><span class="meta">'
            + stnObj.getWindSpeed()
            + '</span> Wind Speed</a></li>'
            + '<li><a href="#"><span class="meta">'
            + stnObj.getRain()
            + '&rdquo;</span> Rainfall</a></li>'
            + '</ol>'
            + '</div>'
            + '<a href="map.html" class="backToMap"><img src="img/map.png"/> Back to Map</a>'
}
/*
 * @function createInfoBox: create information box based on the given station
 * object @para:Station stnObj @return: InfoBox ib
 * 
 */

/*
 * @function createStnObjs: make Station objects by the given associate array it
 * makes much easier when display different type of station infomation.
 * @para:Object[] station @return: Station[] stnObjs
 * 
 */
function createStnObjs(stations, tag) {
    var stnObjs = [];
    for (var i = 0; i < stations.length; i++) {
        stnObjs[i] = Station.createStnObj(stations[i], tag);
    }
    return stnObjs;
}

function getBounds(map) {
    var bound = {};
    var bounds = map.getBounds();
    var sw = bounds.getSouthWest();
    var ne = bounds.getNorthEast();
    bound.lowLat = sw.lat();
    bound.lowLng = sw.lng();
    bound.highLat = ne.lat();
    bound.highLng = ne.lng();
    bound.toString = function () {
        return "Lat:[" + bound.lowLat + "," + bound.highLat + "] Lng:["
                + bound.lowLng + "," + bound.highLng + "]";
    }
    bound.pixelsPerRadLat = function () {
        // Detecting user's screen size using window.screen
        // alert(window.screen.availHeight);
        return screenHeight / (bound.highLat - bound.lowLat);
    }
    bound.pixelsPerRadLng = function () {
        // Detecting user's screen size using window.screen
        return screenWidth / (bound.highLng - bound.lowLng);
    }
    bound.ignore = function (preBound) {
        var dx = (bound.lowLat - preBound.lowLat > 0 ? bound.lowLat
                - preBound.lowLat : preBound.lowLat - bound.lowLat);
        var dy = (bound.lowLng - preBound.lowLng > 0 ? bound.lowLng
                - preBound.lowLng : preBound.lowLng - bound.lowLng);
        if (dx + dy < 0.05) {
            return true;
        }
        return false;
    }
    return bound;
}
/*
 * @function filter: kick out the stations of which 1. the lat & lng are not in
 * the bound. 2. temperature != 'NA' @para:Station[] stations @para:Bound bound
 * @return: Station[] eligiableStns
 * 
 */
function filter(stations, bound) {
    var eligiableStns = [];
    var j = 0;
    for (var i = 0; i < stations.length; i++) {
        if (stations[i].lat > bound.lowLat + 0.01
                && stations[i].lat < bound.highLat - 0.01
                && stations[i].lng > bound.lowLng + 0.01
                && stations[i].lng < bound.highLng - 0.01) {
            if (stations[i].getTemp() !== 'NA') {
                eligiableStns[j] = stations[i];
                j++;
            }
        }
    }
    return eligiableStns;
}

/*
 * @function removeOverlap: keep the stations having no overlap @para:Station[]
 * stations @para:Bound bound @return: Station[] noOverLapStns
 * 
 */
function removeOverlap(noOverLapStns, stations, pixelPerRadLat, pixelPerRadLng) {
    for (var i = 0; i < stations.length; i++) {
        var overlap = false;
        for (var j = 0; j < noOverLapStns.length; j++) {
            overlap = haveOverlap(stations[i], noOverLapStns[j],
                    pixelPerRadLat, pixelPerRadLng);
            if (overlap) {
                // alert("overlap");
                break;
            }
        }
        if (!overlap)
            noOverLapStns[noOverLapStns.length] = stations[i];
    }
    // alert(noOverLapStns.length);
    return noOverLapStns;
}

function haveOverlap(stnA, stnB, pixelPerRadLat, pixelPerRadLng) {
    var distance = stnA.pixelDistance(stnB, pixelPerRadLat, pixelPerRadLng);
    if (distance < 50)
        return true;
    return false;
}
function DataControl(controlDiv, map) {

    // Set CSS styles for the DIV containing the control
    // Setting padding to 5 px will offset the control
    // from the edge of the map
    controlDiv.style.padding = '15px';
    var controlUI = document.createElement('div');
    controlUI.style.backgroundColor = 'white';
    controlUI.style.borderStyle = 'solid';
    controlUI.innerHTML = '<div>' + '<label class="fawnLabel" id="checkbox"onclick="fawnCheck()">'
            + '<input id="fawn" type="checkbox" >' + 'Fawn' + '</label>'
            + ' </div>'

    controlDiv.appendChild(controlUI);
    controlMadis = document.createElement('div');
    controlMadis.innerHTML = '<div>'
            + '<label class="madisLabel" id="checkbox2"onclick="madisCheck()">'
            + ' <input id="madis" type="checkbox">' + ' Madis' + ' </label>'
    '</div>';
    controlUI.appendChild(controlMadis);
    controlText = document.createElement('div');
    controlText.innerHTML = '<div>'
            + '<label class="gladStoneFamilyLabel" id="checkbox3"onclick="growerCheck()">'
            + '<input id="grower" type="checkbox" >' + 'Grower' + '</label>'
            + ' </div>';
    controlUI.appendChild(controlText);
    google.maps.event.addDomListener(controlUI, 'click', function () {
        // alert("click");
        previousData = [];
        var flag1 = fawnCheck();
        var flag2 = madisCheck();
        var flag3 = growerCheck();
        // alert(flag1);
        if (flag1 == true) {
            showData(fawnStnData);
        }
        if (flag2 == true) {
            showData(madisStnData);
        }
        if (flag3 == true) {
            showData(growerStnData);
        }
    });

}
// using html5 geolocation to get the location of the current user, brower
// support IE,Firefox,chrome,safari,opera
function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
        // alert(location[0]);
    } else {
        alert("Geolocation is not supported by this browser.");
    }
}
function showPosition(position) {
    var location = new Array(2);
    var lat = position.coords.latitude;
    var lng = position.coords.longitude;
    location[0] = lat;
    location[1] = lng;
    // alert(location[0]);
    // alert(lng);
    map.setCenter(new google.maps.LatLng(lat, lng));
}
function initMap() {
    loadData();
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showPosition);
    } else {
        return;
    }
    var weather_style = [
        {
            featureType: "administrative",
            elementType: "labels",
            stylers: [
                {
                    visibility: "off"
                }
            ]
        },
        {
            featureType: "poi",
            elementType: "labels",
            stylers: [
                {
                    visibility: "off"
                }
            ]
        },
        {
            featureType: "water",
            elementType: "labels",
            stylers: [
                {
                    visibility: "on"
                }
            ]
        },
        {
            featureType: "road",
            elementType: "labels",
            stylers: [
                {
                    visibility: "off"
                }
            ]
        }
    ];
    // set the center of the map
    var centerLatLng = new google.maps.LatLng(28.2967, -81.3668);
    var map = new google.maps.Map(document.getElementById('map'), {
        mapTypeControlOptions: {
            mapTypeIds: [ 'weather' ]
        },
        // center: centerLatLng,
        zoom: 9,
        mapTypeId: 'weather'
    });
    map.mapTypes.set('weather', new google.maps.StyledMapType(weather_style, {
        name: 'weather'
    }));
    var homeControlDiv = document.createElement('div');
    var homeControl = new DataControl(homeControlDiv, map);
    homeControlDiv.index = -1;
    map.controls[google.maps.ControlPosition.RIGHT_TOP].push(homeControlDiv);
    getLocation();
    return map;

}

</script>
</body>
</html>